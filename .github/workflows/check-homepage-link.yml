name: Check Homepage Weekly Report Link

on:
  push:
    branches: [main]
    paths:
      - 'docs/Narrator/weekly_digest/*.md'
      - 'docs/index.md'
  schedule:
    # 每週一早上 8 點 (UTC+8 = UTC 0:00)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  check-homepage-link:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Find latest weekly digest
        id: find-latest
        run: |
          # 找出最新的週報檔案（依檔名排序）
          LATEST=$(ls -1 docs/Narrator/weekly_digest/????-W??-weekly-digest.md 2>/dev/null | sort -r | head -1)

          if [ -z "$LATEST" ]; then
            echo "::error::No weekly digest found"
            exit 1
          fi

          # 取得檔名（不含路徑和副檔名）
          LATEST_NAME=$(basename "$LATEST" .md)
          echo "latest=$LATEST_NAME" >> $GITHUB_OUTPUT
          echo "Latest weekly digest: $LATEST_NAME"

      - name: Check homepage link
        id: check-link
        run: |
          LATEST="${{ steps.find-latest.outputs.latest }}"

          # 檢查首頁是否連結到最新週報
          if grep -q "$LATEST" docs/index.md; then
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "✅ Homepage links to latest weekly digest: $LATEST"
          else
            echo "status=outdated" >> $GITHUB_OUTPUT
            # 找出首頁目前連結的週報
            CURRENT=$(grep -oP '(?<=weekly_digest/)\d{4}-W\d{2}-weekly-digest' docs/index.md | head -1)
            echo "::warning::Homepage links to $CURRENT but latest is $LATEST"
            echo "current=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if outdated
        if: steps.check-link.outputs.status == 'outdated'
        uses: actions/github-script@v7
        with:
          script: |
            const latest = '${{ steps.find-latest.outputs.latest }}';
            const current = '${{ steps.check-link.outputs.current }}';

            // 檢查是否已有相同 issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'homepage-outdated'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `首頁週報連結過時：請更新至 ${latest}`,
                body: `## 問題描述\n\n首頁目前連結到 \`${current}\`，但最新週報是 \`${latest}\`。\n\n## 建議修改\n\n請更新 \`docs/index.md\` 中的週報連結。\n\n---\n\n*此 Issue 由自動化檢查產生*`,
                labels: ['homepage-outdated', 'automated']
              });
            }
