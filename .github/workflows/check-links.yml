name: Check and Fix Links

on:
  # åœ¨ Pages éƒ¨ç½²å®Œæˆå¾Œè§¸ç™¼
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  # æ¯é€±ä¸€æª¢æŸ¥ä¸€æ¬¡ï¼ˆå¤–éƒ¨é€£çµå¯èƒ½å¤±æ•ˆï¼‰
  schedule:
    - cron: '0 6 * * 1'

jobs:
  check-and-fix:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event.workflow_run.conclusion == 'success'

    permissions:
      contents: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Wait for Pages CDN
        if: github.event_name == 'workflow_run'
        run: sleep 30

      - name: Check links with lychee
        id: lychee
        uses: lycheeverse/lychee-action@v2
        with:
          args: >-
            --config .lychee.toml
            --base 'https://weiqi-kids.github.io/agent.disease-and-advisory'
            --format markdown
            'docs/**/*.md'
          output: lychee-report.md
          fail: false  # ä¸ç«‹å³å¤±æ•—ï¼Œå…ˆå˜—è©¦ä¿®å¾©

      - name: Auto-fix broken links
        id: fix
        if: steps.lychee.outputs.exit_code != 0
        run: |
          chmod +x scripts/fix-broken-links.sh
          if bash scripts/fix-broken-links.sh; then
            echo "all_fixed=true" >> $GITHUB_OUTPUT
          else
            echo "all_fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit fixes
        if: steps.fix.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          if git diff --cached --quiet; then
            echo "No fixes to commit"
          else
            git commit -m "fix: auto-fix broken links

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
            echo "âœ… Fixes committed and pushed"
          fi

      - name: Upload report
        if: steps.fix.outputs.all_fixed == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: link-reports
          path: |
            lychee-report.md
            unfixable-links.md
          retention-days: 7

      - name: Create issue for unfixable links
        if: steps.fix.outputs.all_fixed == 'false'
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'ğŸ”— ç„¡æ³•è‡ªå‹•ä¿®å¾©çš„é€£çµ'
          content-filepath: unfixable-links.md
          labels: |
            bug
            automated
            needs-manual-fix

      - name: Final status
        run: |
          if [[ "${{ steps.lychee.outputs.exit_code }}" == "0" ]]; then
            echo "âœ… æ‰€æœ‰é€£çµæ­£å¸¸"
          elif [[ "${{ steps.fix.outputs.all_fixed }}" == "true" ]]; then
            echo "âœ… æ‰€æœ‰å•é¡Œå·²è‡ªå‹•ä¿®å¾©"
          else
            echo "âš ï¸ æœ‰ç„¡æ³•è‡ªå‹•ä¿®å¾©çš„é€£çµï¼Œå·²å»ºç«‹ Issue"
            exit 1
          fi
