name: Check Links

on:
  # åœ¨ Pages éƒ¨ç½²å®Œæˆå¾Œè§¸ç™¼
  workflow_run:
    workflows: ["pages-build-deployment"]
    types:
      - completed
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  # æ¯é€±ä¸€æª¢æŸ¥ä¸€æ¬¡ï¼ˆå¤–éƒ¨é€£çµå¯èƒ½å¤±æ•ˆï¼‰
  schedule:
    - cron: '0 6 * * 1'

jobs:
  check-links:
    runs-on: ubuntu-latest
    # åªåœ¨ Pages éƒ¨ç½²æˆåŠŸå¾ŒåŸ·è¡Œï¼Œæˆ–æ‰‹å‹•/æŽ’ç¨‹è§¸ç™¼
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      - name: Wait for Pages deployment
        if: github.event_name == 'workflow_run'
        run: sleep 30  # ç­‰å¾… CDN æ›´æ–°

      - name: Check links with lychee
        uses: lycheeverse/lychee-action@v2
        with:
          # ä½¿ç”¨ .lychee.toml è¨­å®šæª”
          args: >-
            --config .lychee.toml
            --base 'https://weiqi-kids.github.io/agent.disease-and-advisory'
            'docs/**/*.md'
          output: lychee-report.md
          fail: true

      - name: Upload report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lychee-report
          path: lychee-report.md
          retention-days: 7

      - name: Create issue on failure
        if: failure()
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: 'ðŸ”— Broken links detected'
          content-filepath: lychee-report.md
          labels: |
            bug
            automated
